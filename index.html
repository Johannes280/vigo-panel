<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIGO FORCE v98</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: white; 
            touch-action: manipulation;
        }
        .vigo-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .status-online { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        input[type="datetime-local"] { color-scheme: dark; }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <!-- Header -->
    <div class="w-full max-w-md flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-black tracking-tighter italic text-emerald-500">VIGO FORCE</h1>
            <div id="status" class="text-[10px] font-bold tracking-widest opacity-50 uppercase">BAĞLANTI BEKLENİYOR...</div>
        </div>
        <button onclick="openAdmin()" class="p-3 vigo-card">⚙️</button>
    </div>

    <!-- Main Timer -->
    <div class="w-full max-w-md v_card p-6 text-center vigo-card mb-4 border-emerald-500/30 border-2">
        <div class="text-[10px] uppercase tracking-[0.3em] mb-2 opacity-60">Sistem Açılış Sayacı</div>
        <div id="countdown" class="text-5xl font-black tabular-nums tracking-tighter">00:00:00</div>
    </div>

    <!-- Registration Form -->
    <div id="form-box" class="w-full max-w-md space-y-4 opacity-30 pointer-events-none transition-all duration-700">
        <div class="vigo-card p-4">
            <label class="text-[10px] font-bold uppercase mb-2 block opacity-50">Kurye Ad Soyad</label>
            <input type="text" id="kurye-ad" placeholder="ADINIZI YAZINIZ" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-lg font-bold uppercase outline-none focus:border-emerald-500">
        </div>

        <div id="gunler-grid" class="grid grid-cols-1 gap-2">
            <!-- Days rendered here -->
        </div>

        <button id="kaydet-btn" disabled class="w-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 p-5 rounded-xl font-black uppercase text-sm shadow-xl transition-all">
            GÜN SEÇİNİZ
        </button>
    </div>

    <!-- Success View -->
    <div id="success-box" class="hidden w-full max-w-md vigo-card p-10 text-center border-emerald-500/50 border-2">
        <div class="text-5xl mb-4">✅</div>
        <h2 class="text-2xl font-black uppercase mb-2">KAYIT TAMAM</h2>
        <p id="secilen-bilgi" class="text-emerald-400 font-bold mb-6 italic"></p>
        <button onclick="resetLocal()" class="text-[10px] uppercase font-bold underline opacity-40">Seçimi Değiştir / Bilgileri Güncelle</button>
    </div>

    <!-- Live List -->
    <div class="w-full max-w-md mt-8">
        <h3 class="text-xs font-bold uppercase mb-4 opacity-40 italic">Güncel Katılım Listesi</h3>
        <div id="liste-container" class="space-y-3"></div>
    </div>

    <!-- Admin Panel (v96 Style) -->
    <div id="admin-panel" class="fixed inset-0 bg-slate-950/95 z-50 hidden p-6 overflow-y-auto">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black italic">YÖNETİM</h2>
                <button onclick="closeAdmin()" class="text-4xl">×</button>
            </div>

            <div class="space-y-6">
                <div class="vigo-card p-4">
                    <label class="text-xs font-bold mb-2 block">Sistem Açılış Zamanı</label>
                    <input type="datetime-local" id="admin-tarih" class="w-full bg-slate-900 p-3 rounded border border-slate-700 mb-3">
                    <button onclick="saveConfig()" class="w-full bg-blue-600 p-3 rounded font-bold">ZAMANI GÜNCELLE</button>
                </div>

                <div class="vigo-card p-4">
                    <label class="text-xs font-bold mb-4 block">Günlük Kontenjanlar</label>
                    <div id="quota-list" class="space-y-2 mb-4">
                        <!-- Quotas here -->
                    </div>
                    <button onclick="saveQuotas()" class="w-full bg-emerald-600 p-3 rounded font-bold uppercase">Kotaları Kaydet</button>
                </div>

                <div class="flex gap-2">
                    <button onclick="downloadExcel()" class="flex-1 bg-slate-800 p-4 rounded font-bold text-xs uppercase italic">Excel İndir</button>
                    <button onclick="resetSystem()" class="flex-1 bg-red-900/50 text-red-400 border border-red-900 p-4 rounded font-bold text-xs uppercase italic">Sistemi Sıfırla</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { initializeFirestore, doc, onSnapshot, setDoc, collection, getDocs, deleteDoc, serverTimestamp, persistentLocalCache } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBsm4DNTCY681X1foMbx-79YfDqcMXTAcg",
            authDomain: "vigoanketler.firebaseapp.com",
            projectId: "vigoanketler",
            storageBucket: "vigoanketler.firebasestorage.app",
            messagingSenderId: "458653861576",
            appId: "1:458653861576:web:21176fee0e23f7d64007fd"
        };

        const app = initializeApp(firebaseConfig);
        // Force Long Polling for WiFi and Operator Bypass
        const db = initializeFirestore(app, {
            experimentalForceLongPolling: true,
            localCache: persistentLocalCache()
        });

        const DAYS = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
        let state = { config: { open: "2026-01-01T10:00", v: 1, quotas: {} }, votes: [], activeDay: null };

        // Realtime Sync
        function initSync() {
            onSnapshot(doc(db, "v98_core", "config"), (s) => {
                if(s.exists()) {
                    state.config = s.data();
                    if(!state.config.quotas) state.config.quotas = {};
                    DAYS.forEach(d => { if(!state.config.quotas[d]) state.config.quotas[d] = 10; });
                    document.getElementById('status').innerText = "SİSTEM AKTİF • BAĞLI";
                    document.getElementById('status').className = "text-[10px] font-bold tracking-widest status-online uppercase";
                    checkLock();
                    renderQuotas();
                }
                render();
            });

            onSnapshot(collection(db, "v98_votes"), (s) => {
                state.votes = s.docs.map(d => d.data());
                render();
            });
        }

        function render() {
            const grid = document.getElementById('gunler-grid');
            grid.innerHTML = DAYS.map(d => {
                const count = state.votes.filter(v => v.day === d).length;
                const limit = state.config.quotas[d] || 10;
                const isFull = count >= limit;
                const isActive = state.activeDay === d;

                return `
                    <button onclick="window.selectDay('${d}', ${isFull})" 
                        class="p-4 vigo-card flex justify-between items-center transition-all ${isActive ? 'border-emerald-500 bg-emerald-500/10' : ''} ${isFull ? 'opacity-30 grayscale cursor-not-allowed' : ''}">
                        <span class="font-black text-sm uppercase tracking-wider ${isActive ? 'text-emerald-500' : ''}">${d}</span>
                        <span class="text-xs font-bold ${isFull ? 'text-red-500' : 'text-emerald-400'}">${count} / ${limit}</span>
                    </button>
                `;
            }).join('');

            const list = document.getElementById('liste-container');
            list.innerHTML = DAYS.map(d => {
                const users = state.votes.filter(v => v.day === d);
                if(users.length === 0) return '';
                return `
                    <div class="vigo-card p-4">
                        <div class="text-[9px] font-bold opacity-30 uppercase mb-2 italic">${d}</div>
                        <div class="flex flex-wrap gap-2">
                            ${users.map(u => `<span class="bg-slate-900 border border-slate-700 px-2 py-1 rounded text-[10px] font-bold uppercase">${u.name}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderQuotas() {
            const box = document.getElementById('quota-list');
            box.innerHTML = DAYS.map(d => `
                <div class="flex items-center justify-between bg-slate-900 p-2 rounded">
                    <span class="text-[10px] font-bold uppercase">${d}</span>
                    <input type="number" data-day="${d}" value="${state.config.quotas[d] || 10}" class="w-16 bg-slate-800 text-center rounded p-1 text-emerald-400 font-bold border border-slate-700">
                </div>
            `).join('');
        }

        window.selectDay = (d, full) => {
            if(full) return;
            state.activeDay = d;
            const btn = document.getElementById('kaydet-btn');
            btn.disabled = false;
            btn.innerText = d.toUpperCase() + " GÜNÜNÜ KAYDET";
            render();
        }

        document.getElementById('kaydet-btn').onclick = async () => {
            const name = document.getElementById('kurye-ad').value.trim().toUpperCase();
            if(name.length < 3) return alert("AD SOYAD EKSİK!");

            const btn = document.getElementById('kaydet-btn');
            btn.disabled = true;
            btn.innerText = "BEKLEYİN...";

            try {
                // Re-check quota for racing condition
                const currentCount = state.votes.filter(v => v.day === state.activeDay).length;
                if(currentCount >= (state.config.quotas[state.activeDay] || 10)) {
                    alert("Kontenjan doldu!");
                    return location.reload();
                }

                await setDoc(doc(db, "v98_votes", name), {
                    name, day: state.activeDay, v: state.config.v, ts: serverTimestamp()
                });
                
                localStorage.setItem('vigo_v98_lock', JSON.stringify({ name, day: state.activeDay, v: state.config.v }));
                location.reload();
            } catch(e) {
                alert("Hata! Tekrar deneyin.");
                btn.disabled = false;
            }
        };

        function checkLock() {
            const lock = localStorage.getItem('vigo_v98_lock');
            if(lock) {
                const data = JSON.parse(lock);
                if(data.v === state.config.v) {
                    document.getElementById('form-box').classList.add('hidden');
                    document.getElementById('success-box').classList.remove('hidden');
                    document.getElementById('secilen-bilgi').innerText = "GÜN: " + data.day;
                }
            }
        }

        window.resetLocal = () => {
            if(confirm("Seçiminizi değiştirmek istediğinize emin misiniz?")) {
                localStorage.removeItem('vigo_v98_lock');
                location.reload();
            }
        };

        window.openAdmin = () => { if(prompt("Şifre:") === "vigo44") document.getElementById('admin-panel').classList.remove('hidden'); };
        window.closeAdmin = () => document.getElementById('admin-panel').classList.add('hidden');

        window.saveConfig = async () => {
            const open = document.getElementById('admin-tarih').value;
            await setDoc(doc(db, "v98_core", "config"), { open, v: state.config.v }, {merge:true});
            alert("Süre güncellendi.");
        };

        window.saveQuotas = async () => {
            const inputs = document.querySelectorAll('#quota-list input');
            const newQuotas = {};
            inputs.forEach(i => newQuotas[i.dataset.day] = parseInt(i.value) || 0);
            await setDoc(doc(db, "v98_core", "config"), { quotas: newQuotas }, {merge:true});
            alert("Kotalar güncellendi!");
        };

        window.resetSystem = async () => {
            if(!confirm("Tüm veriler silinecek?")) return;
            const snap = await getDocs(collection(db, "v98_votes"));
            for(const d of snap.docs) await deleteDoc(doc(db, "v98_votes", d.id));
            const newV = (state.config.v || 0) + 1;
            await setDoc(doc(db, "v98_core", "config"), { v: newV }, {merge:true});
            localStorage.removeItem('vigo_v98_lock');
            alert("Sıfırlandı!");
            location.reload();
        };

        window.downloadExcel = () => {
            const sorted = state.votes.sort((a,b) => DAYS.indexOf(a.day) - DAYS.indexOf(b.day));
            const data = sorted.map(v => ({ "Kurye": v.name, "Gün": v.day }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Liste");
            XLSX.writeFile(wb, "Vigo_Liste.xlsx");
        };

        function tick() {
            const target = new Date(state.config.open).getTime();
            const diff = target - Date.now();
            if(diff > 0) {
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('countdown').innerText = `${h}:${m}:${s}`;
                document.getElementById('form-box').style.opacity = "0.2";
                document.getElementById('form-box').style.pointerEvents = "none";
            } else {
                document.getElementById('countdown').innerHTML = `<span class="text-emerald-400">AKTİF</span>`;
                document.getElementById('form-box').style.opacity = "1";
                document.getElementById('form-box').style.pointerEvents = "auto";
            }
            requestAnimationFrame(tick);
        }

        initSync();
        tick();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIGO FORCE v99</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: white; 
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .vigo-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.25rem;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .dot-online { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .dot-offline { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
        
        input[type="datetime-local"] { 
            color-scheme: dark;
            background: #0f172a !important;
            border: 1px solid #334155;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <!-- Header & Status -->
    <div class="w-full max-w-md flex justify-between items-center mb-6 px-2">
        <div>
            <h1 class="text-3xl font-black italic text-emerald-500 tracking-tighter">VIGO FORCE <span class="text-xs not-italic text-slate-500">v99</span></h1>
            <div id="status-container" class="flex items-center mt-1">
                <span id="status-dot" class="status-dot dot-offline"></span>
                <span id="status-text" class="text-[10px] font-bold tracking-widest uppercase opacity-60 text-red-500">BAĞLANTI KESİLDİ</span>
            </div>
        </div>
        <button onclick="openAdmin()" class="w-12 h-12 vigo-card flex items-center justify-center text-xl">⚙️</button>
    </div>

    <!-- Countdown Display -->
    <div class="w-full max-w-md vigo-card p-6 text-center mb-4 border-emerald-500/20 shadow-2xl">
        <div class="text-[10px] uppercase tracking-[0.3em] mb-2 text-slate-400 font-bold">SİSTEM AÇILIŞINA KALAN SÜRE</div>
        <div id="countdown" class="text-6xl font-black tabular-nums tracking-tighter text-white">00:00:00</div>
    </div>

    <!-- Main Content Box -->
    <div id="main-content" class="w-full max-w-md space-y-4">
        
        <!-- Registration Form -->
        <div id="form-section" class="space-y-4 transition-all duration-500 opacity-20 pointer-events-none">
            <div class="vigo-card p-4">
                <label class="text-[10px] font-bold uppercase mb-2 block text-slate-500 italic">KURYE ADI SOYADI</label>
                <input type="text" id="kurye-ad" placeholder="ADINIZI YAZINIZ" class="w-full bg-slate-900 border border-slate-800 p-4 rounded-xl font-bold uppercase text-emerald-400 focus:border-emerald-500 outline-none transition-all">
            </div>

            <div id="gunler-grid" class="grid grid-cols-1 gap-2">
                <!-- Days are generated here -->
            </div>

            <button id="kaydet-btn" disabled class="w-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 p-5 rounded-2xl font-black uppercase text-sm shadow-xl transition-all transform active:scale-95">
                LÜTFEN GÜN SEÇİNİZ
            </button>
        </div>

        <!-- Success Message -->
        <div id="success-box" class="hidden vigo-card p-10 text-center border-emerald-500/40 border-2">
            <div class="text-6xl mb-4">✨</div>
            <h2 class="text-2xl font-black uppercase mb-1">KAYIT ALINDI</h2>
            <p id="user-choice" class="text-emerald-400 font-bold text-lg italic mb-6"></p>
            <button onclick="resetLocal()" class="text-[10px] font-bold uppercase text-slate-500 underline decoration-slate-700 underline-offset-4">Bilgileri Güncelle veya Sil</button>
        </div>

        <!-- Live List -->
        <div class="mt-8">
            <div class="flex items-center gap-2 mb-4 px-2">
                <div class="h-[1px] flex-grow bg-slate-800"></div>
                <h3 class="text-[10px] font-black uppercase text-slate-500 tracking-widest">ANLIK KATILIM LİSTESİ</h3>
                <div class="h-[1px] flex-grow bg-slate-800"></div>
            </div>
            <div id="live-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="fixed inset-0 bg-slate-950/98 z-50 hidden p-6 overflow-y-auto">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black italic text-emerald-500">ADMİN KONTROL</h2>
                <button onclick="closeAdmin()" class="text-4xl text-slate-500">&times;</button>
            </div>

            <div class="space-y-6">
                <div class="vigo-card p-5 border border-blue-500/20">
                    <label class="text-xs font-black mb-3 block text-blue-400">AÇILIŞ TARİHİ VE SAATİ</label>
                    <input type="datetime-local" id="admin-date">
                    <button onclick="updateTimer()" class="w-full bg-blue-600 p-4 mt-4 rounded-xl font-black uppercase text-xs">Sayacı Başlat / Güncelle</button>
                </div>

                <div class="vigo-card p-5 border border-emerald-500/20">
                    <label class="text-xs font-black mb-4 block text-emerald-400">GÜNLÜK KONTENJANLAR</label>
                    <div id="admin-quotas" class="space-y-3 mb-4"></div>
                    <button onclick="saveQuotas()" class="w-full bg-emerald-600 p-4 rounded-xl font-black uppercase text-xs text-white">Kontenjanları Kaydet</button>
                </div>

                <div class="grid grid-cols-2 gap-3 pb-20">
                    <button onclick="exportToExcel()" class="bg-slate-800 p-4 rounded-xl font-bold text-[10px] uppercase">Excel Raporu</button>
                    <button onclick="forceReset()" class="bg-red-900/30 text-red-500 border border-red-900/20 p-4 rounded-xl font-bold text-[10px] uppercase">Sistemi Sıfırla</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { initializeFirestore, doc, onSnapshot, setDoc, collection, getDocs, deleteDoc, serverTimestamp, persistentLocalCache, CACHE_SIZE_UNLIMITED } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config - RE-VERIFIED
        const firebaseConfig = {
            apiKey: "AIzaSyBsm4DNTCY681X1foMbx-79YfDqcMXTAcg",
            authDomain: "vigoanketler.firebaseapp.com",
            projectId: "vigoanketler",
            storageBucket: "vigoanketler.firebasestorage.app",
            messagingSenderId: "458653861576",
            appId: "1:458653861576:web:21176fee0e23f7d64007fd"
        };

        const app = initializeApp(firebaseConfig);
        
        // FORCE LONG POLLING: This bypasses all proxy/firewall connection errors
        const db = initializeFirestore(app, {
            experimentalForceLongPolling: true,
            localCache: persistentLocalCache({cacheSizeBytes: CACHE_SIZE_UNLIMITED})
        });

        const DAYS = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
        let state = { config: { open: "", v: 1, quotas: {} }, votes: [], selectedDay: null };

        // 1. Sync System Configuration
        function syncSystem() {
            onSnapshot(doc(db, "v99_core", "config"), (snapshot) => {
                if(snapshot.exists()) {
                    state.config = snapshot.data();
                    
                    // Update Status UI
                    document.getElementById('status-dot').className = "status-dot dot-online";
                    document.getElementById('status-text').innerText = "SİSTEME BAĞLANDI";
                    document.getElementById('status-text').className = "text-[10px] font-bold tracking-widest uppercase text-emerald-500";
                    
                    if(state.config.open) document.getElementById('admin-date').value = state.config.open;
                    
                    checkUserLock();
                    renderQuotas();
                    renderUI();
                } else {
                    // Create default config if not exists
                    initDefaultConfig();
                }
            }, (error) => {
                console.error("Firebase Error:", error);
                document.getElementById('status-dot').className = "status-dot dot-offline";
                document.getElementById('status-text').innerText = "BAĞLANTI HATASI";
            });

            onSnapshot(collection(db, "v99_votes"), (snapshot) => {
                state.votes = snapshot.docs.map(doc => doc.data());
                renderUI();
            });
        }

        async function initDefaultConfig() {
            const defaultQuotas = {};
            DAYS.forEach(d => defaultQuotas[d] = 10);
            await setDoc(doc(db, "v99_core", "config"), { open: "", v: 1, quotas: defaultQuotas });
        }

        function renderUI() {
            const grid = document.getElementById('gunler-grid');
            grid.innerHTML = DAYS.map(d => {
                const count = state.votes.filter(v => v.day === d).length;
                const limit = (state.config.quotas && state.config.quotas[d]) ? state.config.quotas[d] : 10;
                const isFull = count >= limit;
                const isSelected = state.selectedDay === d;

                return `
                    <button onclick="window.handleSelect('${d}', ${isFull})" 
                        class="p-4 vigo-card flex justify-between items-center transition-all ${isSelected ? 'border-emerald-500 bg-emerald-500/10' : ''} ${isFull ? 'opacity-20 grayscale' : ''}">
                        <span class="font-bold text-sm uppercase tracking-wider ${isSelected ? 'text-emerald-500' : 'text-slate-300'}">${d}</span>
                        <span class="text-xs font-black ${isFull ? 'text-red-500' : 'text-emerald-500'}">${count} / ${limit}</span>
                    </button>
                `;
            }).join('');

            // Render Live List
            const listContainer = document.getElementById('live-list');
            const grouped = DAYS.map(d => {
                const users = state.votes.filter(v => v.day === d);
                if(users.length === 0) return '';
                return `
                    <div class="vigo-card p-4">
                        <div class="text-[9px] font-black text-slate-600 uppercase mb-2 tracking-tighter">${d}</div>
                        <div class="flex flex-wrap gap-2">
                            ${users.map(u => `<span class="bg-slate-900/50 px-2 py-1 rounded text-[10px] font-bold uppercase text-slate-400 border border-slate-800">${u.name}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            listContainer.innerHTML = grouped || '<div class="text-center py-8 opacity-20 text-xs font-bold uppercase">Henüz bir kayıt bulunmuyor</div>';
        }

        function renderQuotas() {
            const container = document.getElementById('admin-quotas');
            if(!state.config.quotas) return;
            container.innerHTML = DAYS.map(d => `
                <div class="flex items-center justify-between bg-slate-900 p-3 rounded-xl border border-slate-800">
                    <span class="text-[10px] font-black uppercase text-slate-500">${d}</span>
                    <input type="number" data-day="${d}" value="${state.config.quotas[d] || 10}" 
                        class="w-16 bg-slate-950 text-center rounded-lg p-2 text-emerald-400 font-black border border-slate-700">
                </div>
            `).join('');
        }

        window.handleSelect = (day, full) => {
            if(full) return;
            state.selectedDay = day;
            const btn = document.getElementById('kaydet-btn');
            btn.disabled = false;
            btn.innerText = day.toUpperCase() + " GÜNÜNE KAYDOL";
            renderUI();
        };

        document.getElementById('kaydet-btn').onclick = async () => {
            const name = document.getElementById('kurye-ad').value.trim().toUpperCase();
            if(name.length < 3) return alert("Lütfen adınızı giriniz!");

            const btn = document.getElementById('kaydet-btn');
            btn.disabled = true;
            btn.innerText = "İŞLENİYOR...";

            try {
                // Double Check for Quota
                const currentCount = state.votes.filter(v => v.day === state.selectedDay).length;
                const limit = state.config.quotas[state.selectedDay] || 10;
                
                if(currentCount >= limit) {
                    alert("Kontenjan doldu!");
                    return location.reload();
                }

                await setDoc(doc(db, "v99_votes", name), {
                    name, day: state.selectedDay, v: state.config.v, ts: serverTimestamp()
                });

                localStorage.setItem('vigo_v99_auth', JSON.stringify({ name, day: state.selectedDay, v: state.config.v }));
                location.reload();
            } catch(e) {
                alert("Bağlantı hatası. İnternetinizi kontrol edip tekrar deneyin.");
                btn.disabled = false;
            }
        };

        function checkUserLock() {
            const auth = localStorage.getItem('vigo_v99_auth');
            if(auth) {
                const data = JSON.parse(auth);
                if(data.v === state.config.v) {
                    document.getElementById('form-section').classList.add('hidden');
                    document.getElementById('success-box').classList.remove('hidden');
                    document.getElementById('user-choice').innerText = data.day;
                }
            }
        }

        window.resetLocal = () => {
            if(confirm("Kaydı silip yeniden seçmek istiyor musunuz?")) {
                localStorage.removeItem('vigo_v99_auth');
                location.reload();
            }
        };

        // Admin Functions
        window.openAdmin = () => {
            const p = prompt("Yönetici Şifresi:");
            if(p === "vigo44") document.getElementById('admin-panel').classList.remove('hidden');
        };
        window.closeAdmin = () => document.getElementById('admin-panel').classList.add('hidden');

        window.updateTimer = async () => {
            const date = document.getElementById('admin-date').value;
            if(!date) return alert("Tarih seçin!");
            await setDoc(doc(db, "v99_core", "config"), { open: date }, { merge: true });
            alert("Sayaç Güncellendi");
        };

        window.saveQuotas = async () => {
            const inputs = document.querySelectorAll('#admin-quotas input');
            const q = {};
            inputs.forEach(i => q[i.dataset.day] = parseInt(i.value));
            await setDoc(doc(db, "v99_core", "config"), { quotas: q }, { merge: true });
            alert("Kontenjanlar Kaydedildi");
        };

        window.forceReset = async () => {
            if(!confirm("DİKKAT! Tüm veriler silinecek. Emin misiniz?")) return;
            const snap = await getDocs(collection(db, "v99_votes"));
            for (const d of snap.docs) await deleteDoc(doc(db, "v99_votes", d.id));
            const newV = (state.config.v || 1) + 1;
            await setDoc(doc(db, "v99_core", "config"), { v: newV }, { merge: true });
            localStorage.removeItem('vigo_v99_auth');
            location.reload();
        };

        window.exportToExcel = () => {
            const data = state.votes.map(v => ({ "Kurye": v.name, "Gün": v.day }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rapor");
            XLSX.writeFile(wb, "Vigo_v99_Rapor.xlsx");
        };

        // Timer Logic
        function updateTimerDisplay() {
            if(!state.config || !state.config.open) {
                document.getElementById('countdown').innerText = "00:00:00";
                return requestAnimationFrame(updateTimerDisplay);
            }

            const target = new Date(state.config.open).getTime();
            const now = Date.now();
            const diff = target - now;

            if(diff > 0) {
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('countdown').innerText = `${h}:${m}:${s}`;
                document.getElementById('form-section').classList.add('opacity-20', 'pointer-events-none');
            } else {
                document.getElementById('countdown').innerHTML = `<span class="text-emerald-500">AÇIK</span>`;
                document.getElementById('form-section').classList.remove('opacity-20', 'pointer-events-none');
            }
            requestAnimationFrame(updateTimerDisplay);
        }

        syncSystem();
        updateTimerDisplay();

    </script>
</body>
</html>

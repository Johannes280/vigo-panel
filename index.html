<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIGO FORCE v96</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: system-ui, -apple-system, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 1.5rem;
        }
        .day-btn {
            background: #111;
            border: 1px solid #222;
            transition: all 0.2s;
        }
        .day-btn.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        .day-btn:disabled { opacity: 0.3; }
        
        /* Bağlantı hatası durumunda kullanıcıyı uyarma paneli */
        #retry-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Bağlantı Kurtarma Ekranı -->
    <div id="retry-overlay">
        <div class="text-red-500 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        </div>
        <h2 class="text-xl font-bold mb-2 uppercase">Bağlantı Kurulamadı</h2>
        <p class="text-zinc-500 text-sm mb-6 uppercase tracking-widest">Operatörünüz (Turkcell/Vodafone vb.) sistem erişimini kısıtlıyor olabilir.</p>
        <button onclick="location.reload()" class="bg-white text-black px-8 py-4 rounded-xl font-bold uppercase text-xs">Tekrar Dene</button>
    </div>

    <div class="max-w-md mx-auto p-6 space-y-6">
        
        <header class="text-center py-4">
            <h1 class="text-3xl font-black italic tracking-tighter">VIGO<span class="text-emerald-500">FORCE</span></h1>
            <div id="conn-indicator" class="inline-flex items-center gap-2 px-3 py-1 bg-zinc-900 rounded-full mt-2 border border-zinc-800">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Sistem Hazır</span>
            </div>
        </header>

        <section id="timer-box" class="card p-6 text-center">
            <span class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.3em] block mb-2">Başlamasına Kalan Süre</span>
            <div id="countdown" class="text-4xl font-black italic tabular-nums">00:00:00</div>
        </section>

        <div id="main-ui" class="space-y-6 opacity-40 pointer-events-none transition-opacity duration-700">
            <div class="card p-6 space-y-4">
                <div>
                    <label class="text-[11px] font-bold text-zinc-500 uppercase mb-2 block tracking-widest ml-1">İsim Soyisim</label>
                    <input type="text" id="kurye-name" placeholder="Adınızı yazın..." 
                           class="w-full bg-black border border-zinc-800 p-4 rounded-xl font-bold uppercase text-sm outline-none focus:border-emerald-500">
                </div>

                <div id="days-list" class="space-y-2">
                    <!-- JS ile dolacak -->
                </div>

                <button id="send-btn" class="w-full py-5 bg-emerald-500 text-black rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl shadow-emerald-500/10 active:scale-95 transition-all">
                    Kaydı Tamamla
                </button>
            </div>
        </div>

        <section id="success-screen" class="hidden card p-10 text-center animate-pulse">
            <div class="text-emerald-500 mb-4">
                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-xl font-black uppercase italic">Kayıt Alındı</h2>
            <p id="saved-info" class="text-zinc-500 text-[10px] mt-2 font-bold uppercase tracking-widest"></p>
        </section>

        <div class="space-y-4">
            <h3 class="text-[10px] font-bold text-zinc-600 uppercase tracking-[0.2em] px-2 italic">Anlık Durum</h3>
            <div id="live-data" class="space-y-3"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBsm4DNTCY681X1foMbx-79YfDqcMXTAcg",
            authDomain: "vigoanketler.firebaseapp.com",
            projectId: "vigoanketler",
            storageBucket: "vigoanketler.firebasestorage.app",
            messagingSenderId: "458653861576",
            appId: "1:458653861576:web:21176fee0e23f7d64007fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // OPERATÖR ENGELİNE KARŞI ULTRA DİRENÇLİ MOD
        db._settings.forceLongPolling = true;

        const GUNLER = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
        let localState = {
            config: { openDate: "2024-01-01T00:00:00", quotas: {} },
            votes: [],
            selected: null,
            done: localStorage.getItem('vigo_v96_voted')
        };

        if(localState.done) {
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('success-screen').classList.remove('hidden');
            document.getElementById('saved-info').innerText = `Seçilen Gün: ${localState.done}`;
        }

        // Veri Akışını Başlat
        function init() {
            onSnapshot(doc(db, "vigo_v96", "config"), (s) => {
                if(s.exists()) localState.config = s.data();
                render();
            }, (err) => document.getElementById('retry-overlay').style.display = 'flex');

            onSnapshot(collection(db, "vigo_v96_votes"), (s) => {
                localState.votes = s.docs.map(d => d.data());
                render();
            });
        }
        init();

        function render() {
            const list = document.getElementById('days-list');
            list.innerHTML = GUNLER.map(g => {
                const count = localState.votes.filter(v => v.gun === g).length;
                const max = localState.config.quotas?.[g] || 10;
                const isFull = count >= max;
                const isSel = localState.selected === g;
                
                return `
                    <button onclick="window.pick('${g}', ${isFull})" class="day-btn w-full p-4 rounded-xl flex justify-between items-center ${isSel ? 'selected' : ''} ${isFull ? 'opacity-20 grayscale' : ''}">
                        <span class="text-xs font-bold uppercase ${isSel ? 'text-emerald-500' : 'text-zinc-400'}">${g}</span>
                        <span class="text-[10px] font-black italic ${isFull ? 'text-red-500' : 'text-emerald-500'}">${count} / ${max}</span>
                    </button>
                `;
            }).join('');

            const live = document.getElementById('live-data');
            live.innerHTML = GUNLER.map(g => {
                const users = localState.votes.filter(v => v.gun === g);
                if(users.length === 0) return '';
                return `
                    <div class="card p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-black text-zinc-500 uppercase italic">${g}</span>
                            <span class="text-[9px] font-bold text-zinc-600">${users.length} Kayıt</span>
                        </div>
                        <div class="flex flex-wrap gap-1.5">
                            ${users.map(u => `<span class="px-2 py-1 bg-white/5 rounded border border-white/5 text-[8px] font-bold uppercase text-zinc-400">${u.ad}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.pick = (g, full) => {
            if(full || localState.done) return;
            localState.selected = g;
            render();
        };

        document.getElementById('send-btn').onclick = async () => {
            const name = document.getElementById('kurye-name').value.trim().toUpperCase();
            if(name.length < 5) { alert("Lütfen ad ve soyadınızı tam giriniz."); return; }
            if(!localState.selected) { alert("Lütfen bir gün seçiniz."); return; }

            try {
                const docRef = doc(db, "vigo_v96_votes", name);
                const snap = await getDoc(docRef);
                if(snap.exists()) {
                    alert("Bu isimle zaten kayıt yapılmış!");
                    return;
                }
                await setDoc(docRef, { ad: name, gun: localState.selected, ts: serverTimestamp() });
                localStorage.setItem('vigo_v96_voted', localState.selected);
                location.reload();
            } catch (e) {
                alert("Bağlantı kesildi! Operatörünüz engelliyor olabilir.");
            }
        };

        function tick() {
            const target = new Date(localState.config.openDate).getTime();
            const now = Date.now();
            const diff = target - now;
            
            if(diff > 0) {
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).padStart(2,'0');
                document.getElementById('countdown').innerText = `${h}:${m}:${s}`;
            } else {
                document.getElementById('countdown').innerHTML = `<span class="text-emerald-500 animate-pulse">SİSTEM AÇIK</span>`;
                document.getElementById('main-ui').style.opacity = "1";
                document.getElementById('main-ui').style.pointerEvents = "auto";
                document.getElementById('timer-box').classList.add('border-emerald-500/20');
            }
            requestAnimationFrame(tick);
        }
        tick();

        // Admin (Basit Giriş)
        document.body.addEventListener('dblclick', () => {
            const p = prompt("Yönetici:");
            if(p === "vigo44") {
                const d = prompt("Açılış Tarihi (ISO):", localState.config.openDate);
                if(d) setDoc(doc(db, "vigo_v96", "config"), { ...localState.config, openDate: d }, {merge:true});
            }
        });

    </script>
</body>
</html>

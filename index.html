<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIGO ANKET v87</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505; 
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }

        .neo-card {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 24px;
        }

        .admin-layer { z-index: 999999; }

        input {
            background: #111 !important;
            border: 1px solid #333 !important;
            color: white !important;
        }

        .day-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .day-btn:active { transform: scale(0.95); }

        /* Liste elemanları için animasyon */
        .list-item {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- VIGO FORCE ÜST PANEL -->
    <div class="p-6 text-center">
        <h1 class="text-4xl font-black tracking-tighter italic text-white uppercase">VIGO<span class="text-emerald-500">FORCE</span></h1>
        <p class="text-[10px] text-zinc-500 font-bold tracking-[0.3em] mt-1 uppercase">Vardiya Seçim Sistemi v87</p>
    </div>

    <div class="max-w-md mx-auto px-4 pb-32 space-y-6">
        
        <!-- SAYAÇ / DURUM -->
        <div class="neo-card p-6 text-center border-emerald-500/20 shadow-[0_0_50px_rgba(16,185,129,0.05)]">
            <div id="timer-label" class="text-[9px] font-bold text-zinc-500 mb-1 uppercase tracking-widest">Sistemin Açılmasına Kalan</div>
            <div id="timer-display" class="text-5xl font-black tabular-nums tracking-tighter">00:00:00</div>
        </div>

        <!-- KAYIT FORMU -->
        <div class="neo-card p-6 space-y-4">
            <div>
                <label class="text-[10px] font-black text-zinc-500 ml-1 uppercase">Kurye Ad Soyad</label>
                <input type="text" id="user-name" placeholder="AD SOYAD GİRİNİZ" class="w-full p-4 mt-1 rounded-xl font-bold uppercase outline-none focus:border-emerald-400 transition-all text-sm">
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-zinc-500 ml-1 uppercase">Müsait Olduğunuz Gün</label>
                <div id="days-container" class="grid grid-cols-1 gap-2">
                    <!-- Günler Dinamik Gelecek -->
                </div>
            </div>

            <button id="submit-btn" class="w-full py-5 bg-zinc-800 text-zinc-600 rounded-2xl font-black uppercase text-sm shadow-xl transition-all pointer-events-none">
                Önce Gün Seçin
            </button>
        </div>

        <!-- SEÇİM LİSTESİ (KİM HANGİ GÜNÜ SEÇTİ) -->
        <div class="space-y-4">
            <div class="flex items-center gap-4">
                <div class="h-[1px] flex-1 bg-zinc-800"></div>
                <h2 class="text-xs font-black text-zinc-500 uppercase tracking-widest">GÜNCEL LİSTE</h2>
                <div class="h-[1px] flex-1 bg-zinc-800"></div>
            </div>
            
            <div id="public-list" class="space-y-4">
                <!-- Kayıt yapanlar burada gün gün gruplanacak -->
                <div class="text-center py-10 text-zinc-700 text-xs font-bold italic">Henüz kayıt yapılmadı...</div>
            </div>
        </div>

        <!-- YÖNETİCİ PANELİ TETİKLEYİCİ -->
        <button id="admin-trigger" class="w-full py-4 text-zinc-800 text-[9px] font-black tracking-[0.4em] uppercase border border-zinc-900 rounded-xl hover:text-emerald-500 transition-colors">
            YÖNETİCİ GİRİŞİ
        </button>
    </div>

    <!-- MODALLAR (ŞİFRE VE PANEL) -->
    <div id="auth-modal" class="fixed inset-0 bg-black/98 admin-layer hidden flex-col items-center justify-center p-6 backdrop-blur-md">
        <div class="w-full max-w-xs space-y-4">
            <h2 class="text-2xl font-black text-center text-white italic">ADMİN PANEL</h2>
            <input type="password" id="admin-pass" placeholder="GÜVENLİK ŞİFRESİ" class="w-full p-5 rounded-2xl text-center text-2xl font-black tracking-widest">
            <button id="auth-confirm" class="w-full py-5 bg-emerald-500 text-black font-black rounded-2xl shadow-lg shadow-emerald-500/20 uppercase">Doğrula</button>
            <button onclick="document.getElementById('auth-modal').classList.add('hidden')" class="w-full text-zinc-500 font-bold text-xs uppercase tracking-widest pt-2">Vazgeç</button>
        </div>
    </div>

    <div id="panel-modal" class="fixed inset-0 bg-black admin-layer hidden flex-col overflow-y-auto">
        <div class="p-4 border-b border-zinc-900 flex justify-between items-center sticky top-0 bg-black z-10">
            <span class="font-black text-emerald-500">YÖNETİM</span>
            <button onclick="location.reload()" class="px-6 py-2 bg-zinc-900 text-white rounded-lg text-[10px] font-black uppercase">Kapat</button>
        </div>
        <div id="panel-content" class="p-6 space-y-8"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBsm4DNTCY681X1foMbx-79YfDqcMXTAcg",
            authDomain: "vigoanketler.firebaseapp.com",
            projectId: "vigoanketler",
            storageBucket: "vigoanketler.firebasestorage.app",
            messagingSenderId: "458653861576",
            appId: "1:458653861576:web:21176fee0e23f7d64007fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const GUNLER = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
        
        let state = {
            config: { quotas: {}, openDate: new Date().toISOString() },
            votes: [],
            selected: null
        };

        // --- VERİ TAKİBİ ---
        onSnapshot(doc(db, "vigo_v87", "config"), (s) => {
            if(s.exists()) state.config = s.data();
            renderDays();
        });

        onSnapshot(collection(db, "vigo_v87_votes"), (s) => {
            state.votes = s.docs.map(d => d.data());
            renderDays();
            renderPublicList();
        });

        // --- GÜNLERİ LİSTELE (FORM) ---
        function renderDays() {
            const container = document.getElementById('days-container');
            container.innerHTML = GUNLER.map(g => {
                const count = state.votes.filter(v => v.gun === g).length;
                const max = state.config.quotas?.[g] || 10;
                const isFull = count >= max;
                const isSelected = state.selected === g;

                return `
                    <div onclick="window.handleSelect('${g}', ${isFull})" 
                         class="day-btn p-4 rounded-xl border-2 flex justify-between items-center transition-all
                         ${isSelected ? 'border-emerald-500 bg-emerald-500/10' : 'border-white/5 bg-zinc-900/40'}
                         ${isFull ? 'opacity-30' : 'cursor-pointer hover:bg-zinc-800'}">
                        <span class="font-bold text-xs uppercase ${isSelected ? 'text-emerald-400' : 'text-zinc-300'}">${g}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-black text-zinc-500 uppercase">${isFull ? 'DOLU' : 'AÇIK'}</span>
                            <span class="text-[11px] font-black bg-white/5 px-2 py-1 rounded-lg tabular-nums">${count} / ${max}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- KİM NE SEÇTİ (LİSTE) ---
        function renderPublicList() {
            const container = document.getElementById('public-list');
            const sections = GUNLER.map(g => {
                const users = state.votes.filter(v => v.gun === g);
                if(users.length === 0) return '';
                
                return `
                    <div class="neo-card p-5 list-item border-l-4 border-l-emerald-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-black text-sm uppercase tracking-tighter text-white">${g}</h3>
                            <span class="text-[10px] font-black bg-emerald-500 text-black px-2 py-0.5 rounded italic">${users.length} KİŞİ</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            ${users.map(u => `
                                <div class="bg-white/[0.03] border border-white/[0.05] p-2 rounded-lg text-center">
                                    <p class="text-[10px] font-bold uppercase truncate text-zinc-300">${u.ad}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = sections || '<div class="text-center py-10 text-zinc-700 text-xs font-bold italic">Henüz kayıt yapılmadı...</div>';
        }

        window.handleSelect = (g, full) => {
            if(full) return;
            state.selected = g;
            renderDays();
            const btn = document.getElementById('submit-btn');
            btn.innerText = "KAYDI TAMAMLA VE LİSTEYE EKLE";
            btn.className = "w-full py-5 bg-emerald-500 text-black rounded-2xl font-black uppercase text-sm shadow-xl shadow-emerald-500/10 pointer-events-auto active:scale-95 transition-all";
        };

        document.getElementById('submit-btn').onclick = async () => {
            const nameInput = document.getElementById('user-name');
            const name = nameInput.value.trim().toUpperCase();
            
            if(name.length < 5) { alert("Lütfen Ad Soyad giriniz!"); return; }
            if(!state.selected) { alert("Lütfen bir gün seçiniz!"); return; }

            const diff = new Date(state.config.openDate).getTime() - Date.now();
            if(diff > 0) { alert("Sistem henüz açılmadı, lütfen bekleyin!"); return; }

            try {
                await setDoc(doc(db, "vigo_v87_votes", name), { 
                    ad: name, 
                    gun: state.selected, 
                    ts: Date.now() 
                });
                alert("KAYIT BAŞARILI! Listenin altına eklendiniz.");
                nameInput.value = "";
                state.selected = null;
                renderDays();
            } catch (e) {
                alert("Hata: " + e.message);
            }
        };

        // --- ADMİN PANELİ ---
        document.getElementById('admin-trigger').onclick = () => {
            document.getElementById('auth-modal').classList.replace('hidden', 'flex');
        };

        document.getElementById('auth-confirm').onclick = () => {
            if(document.getElementById('admin-pass').value === "vigo44") {
                document.getElementById('auth-modal').classList.replace('flex', 'hidden');
                document.getElementById('panel-modal').classList.replace('hidden', 'flex');
                renderAdmin();
            }
        };

        function renderAdmin() {
            const content = document.getElementById('panel-content');
            content.innerHTML = `
                <div class="neo-card p-5 space-y-4">
                    <p class="text-xs font-black text-emerald-500 uppercase tracking-widest">Açılış Saati Ayarla</p>
                    <input type="datetime-local" id="admin-date" class="w-full p-4 rounded-xl font-bold border-zinc-800">
                    <button id="save-config" class="w-full py-4 bg-emerald-500 text-black rounded-xl font-black text-xs uppercase">Zamanı Güncelle</button>
                </div>

                <div class="neo-card p-5 space-y-2">
                    <p class="text-xs font-black text-emerald-500 uppercase tracking-widest">Günlük Kontenjanlar</p>
                    ${GUNLER.map(g => `
                        <div class="flex justify-between items-center py-3 border-b border-white/5">
                            <span class="text-xs font-bold uppercase text-zinc-400">${g}</span>
                            <input type="number" onchange="window.setQ('${g}', this.value)" value="${state.config.quotas[g]||10}" class="w-16 p-2 rounded-lg text-center font-bold bg-black border border-zinc-800">
                        </div>
                    `).join('')}
                </div>

                <div class="neo-card p-5">
                    <p class="text-xs font-black text-red-500 uppercase tracking-widest mb-4">Veri Yönetimi</p>
                    <button id="wipe-all" class="w-full py-4 border border-red-900/50 text-red-500 rounded-xl text-[10px] font-black uppercase hover:bg-red-500/10">Tüm Kayıtları Sil (Sıfırla)</button>
                </div>
            `;

            document.getElementById('save-config').onclick = async () => {
                const date = document.getElementById('admin-date').value;
                if(!date) return;
                await setDoc(doc(db, "vigo_v87", "config"), { ...state.config, openDate: new Date(date).toISOString() }, { merge: true });
                alert("Açılış vakti kaydedildi.");
            };

            document.getElementById('wipe-all').onclick = async () => {
                if(confirm("TÜM LİSTE SİLİNECEK! Emin misiniz?")) {
                    const snap = await getDocs(collection(db, "vigo_v87_votes"));
                    for (const d of snap.docs) await deleteDoc(d.ref);
                    alert("Liste temizlendi.");
                }
            };
        }

        window.setQ = async (g, v) => {
            const quotas = { ...state.config.quotas, [g]: parseInt(v) };
            await setDoc(doc(db, "vigo_v87", "config"), { ...state.config, quotas }, { merge: true });
        };

        // --- SAYAÇ DÖNGÜSÜ ---
        setInterval(() => {
            const diff = new Date(state.config.openDate).getTime() - Date.now();
            const display = document.getElementById('timer-display');
            const label = document.getElementById('timer-label');

            if(diff > 0) {
                const h = String(Math.floor(diff/3600000)).padStart(2,'0');
                const m = String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
                const s = String(Math.floor((diff%60000)/1000)).padStart(2,'0');
                display.innerText = `${h}:${m}:${s}`;
                display.classList.replace('text-emerald-500', 'text-white');
                label.innerText = "Sistemin Açılmasına Kalan";
            } else {
                display.innerText = "SİSTEM AÇIK";
                display.className = "text-4xl font-black text-emerald-500 italic tracking-tighter";
                label.innerText = "Kayıtlar Kabul Ediliyor";
            }
        }, 1000);

    </script>
</body>
</html>


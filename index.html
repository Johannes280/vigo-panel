// Listeyi Oluştur
            document.getElementById('liste').innerHTML = GUNLER.map(gun => {
                const kisiler = state.votes.filter(v => v.gun === gun);
                if(kisiler.length === 0) return '';
                return 
                    <div>
                        <p class="text-[9px] font-black text-emerald-500 uppercase mb-1 tracking-tighter">${gun}</p>
                        <div class="flex flex-wrap gap-1">
                            ${kisiler.map(k => <span class="bg-white/5 border border-white/5 px-2 py-1 rounded text-[10px] font-bold text-gray-400">${k.ad}</span>).join('')}
                        </div>
                    </div>
                ;
            }).join('');
        }

        window.veriyiGonder = async () => {
            const ad = inputAd.value.trim().toUpperCase();
            const seciliGun = document.querySelector('input[name="gun"]:checked');

            if (!ad || ad.split(' ').length < 2) return alert("Lütfen Ad ve Soyadınızı tam yazınız.");
            if (!seciliGun) return alert("Lütfen bir gün seçin.");

            const gun = seciliGun.value;
            const docRef = doc(db, "vigo_safe_v3_votes", ad);

            // TRANSACTION: Milisaniye bazında çakışmayı önleyen asıl mekanizma
            try {
                await runTransaction(db, async (transaction) => {
                    const existingVote = await transaction.get(docRef);
                    if (existingVote.exists()) throw "Zaten kaydınız var.";

                    const allVotes = await getDocs(collection(db, "vigo_safe_v3_votes"));
                    const count = allVotes.docs.filter(d => d.data().gun === gun).length;
                    const max = state.config.quotas?.[gun] || 5;

                    if (count >= max) throw "Maalesef bu gün milisaniye farkıyla doldu!";

                    transaction.set(docRef, { ad, gun, ts: Date.now(), time: new Date().toLocaleTimeString('tr-TR') });
                });
                alert("Kayıt Başarılı!");
                inputAd.value = "";
            } catch (e) {
                alert(e);
            }
        };

        // Admin
        window.adminPanel = async () => {
            const pass = prompt("Şifre:");
            if(pass === "Vig.iSt_26") {
                const op = prompt("1: Açılış Saati Ayarla\n2: Kontenjan Ayarla\n3: Listeyi Sıfırla");
                if(op === "1") {
                    const dt = prompt("Tarih ve Saat (Örn: 2026-01-13T20:00):");
                    await setDoc(doc(db, "config"), { ...state.config, openDate: dt }, { merge: true });
                } else if(op === "2") {
                    const q = {}; GUNLER.forEach(g => q[g] = parseInt(prompt(g + " Kontenjanı:", 5)));
                    await setDoc(doc(db, "vigo_safe_v3", "config"), { ...state.config, quotas: q }, { merge: true });
                } else if(op === "3") {
                    if(confirm("TÜM LİSTE SİLİNSİN Mİ?")) {
                        const s = await getDocs(collection(db, "vigo_safe_v3_votes"));
                        s.forEach(d => deleteDoc(d.ref));
                    }
                }
            }
        };

        setInterval(render, 1000);
        init();
    </script>
</body>
</html>

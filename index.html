<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIGO FORCE v98</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: white; 
            touch-action: manipulation;
        }
        .vigo-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .status-online { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        /* Sayaç inputu için mobil uyum */
        input[type="datetime-local"] { 
            color-scheme: dark;
            background: #0f172a !important;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            width: 100%;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <!-- Header -->
    <div class="w-full max-w-md flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-black tracking-tighter italic text-emerald-500">VIGO FORCE</h1>
            <div id="status" class="text-[10px] font-bold tracking-widest opacity-50 uppercase">BAĞLANTI BEKLENİYOR...</div>
        </div>
        <button onclick="openAdmin()" class="p-3 vigo-card">⚙️</button>
    </div>

    <!-- Main Timer Display -->
    <div class="w-full max-w-md v_card p-6 text-center vigo-card mb-4 border-emerald-500/30 border-2">
        <div class="text-[10px] uppercase tracking-[0.3em] mb-2 opacity-60">Sistem Açılış Sayacı</div>
        <div id="countdown" class="text-5xl font-black tabular-nums tracking-tighter">00:00:00</div>
    </div>

    <!-- Main Registration Form -->
    <div id="form-box" class="w-full max-w-md space-y-4 opacity-30 pointer-events-none transition-all duration-700">
        <div class="vigo-card p-4">
            <label class="text-[10px] font-bold uppercase mb-2 block opacity-50">Kurye Ad Soyad</label>
            <input type="text" id="kurye-ad" placeholder="ADINIZI YAZINIZ" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-lg font-bold uppercase outline-none focus:border-emerald-500">
        </div>

        <div id="gunler-grid" class="grid grid-cols-1 gap-2">
            <!-- Days rendered here -->
        </div>

        <button id="kaydet-btn" disabled class="w-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 p-5 rounded-xl font-black uppercase text-sm shadow-xl transition-all">
            GÜN SEÇİNİZ
        </button>
    </div>

    <!-- Registration Success Message -->
    <div id="success-box" class="hidden w-full max-w-md vigo-card p-10 text-center border-emerald-500/50 border-2">
        <div class="text-5xl mb-4">✅</div>
        <h2 class="text-2xl font-black uppercase mb-2">KAYIT TAMAM</h2>
        <p id="secilen-bilgi" class="text-emerald-400 font-bold mb-6 italic"></p>
        <button onclick="resetLocal()" class="text-[10px] uppercase font-bold underline opacity-40">Seçimi Değiştir / Bilgileri Güncelle</button>
    </div>

    <!-- Live Attendance List -->
    <div class="w-full max-w-md mt-8">
        <h3 class="text-xs font-bold uppercase mb-4 opacity-40 italic">Güncel Katılım Listesi</h3>
        <div id="liste-container" class="space-y-3"></div>
    </div>

    <!-- Admin Management Panel -->
    <div id="admin-panel" class="fixed inset-0 bg-slate-950/98 z-50 hidden p-6 overflow-y-auto">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-2xl font-black italic">YÖNETİM PANELİ</h2>
                <button onclick="closeAdmin()" class="text-4xl text-slate-500">&times;</button>
            </div>

            <div class="space-y-6">
                <!-- Timer Configuration -->
                <div class="vigo-card p-5 border border-blue-500/30">
                    <label class="text-xs font-bold mb-3 block text-blue-400">SAYACI AYARLA (Açılış Zamanı)</label>
                    <input type="datetime-local" id="admin-tarih" class="mb-4">
                    <button onclick="saveConfig()" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-lg font-black text-sm transition-colors">SAYACI BAŞLAT / GÜNCELLE</button>
                </div>

                <!-- Daily Quotas -->
                <div class="vigo-card p-5 border border-emerald-500/30">
                    <label class="text-xs font-bold mb-4 block text-emerald-400 uppercase">Günlük Kontenjanlar (Limitler)</label>
                    <div id="quota-list" class="space-y-3 mb-5">
                        <!-- Quotas will be injected here -->
                    </div>
                    <button onclick="saveQuotas()" class="w-full bg-emerald-600 hover:bg-emerald-500 p-4 rounded-lg font-black text-sm uppercase transition-colors">Kontenjanları Kaydet</button>
                </div>

                <!-- System Tools -->
                <div class="grid grid-cols-2 gap-3 pb-20">
                    <button onclick="downloadExcel()" class="bg-slate-800 hover:bg-slate-700 p-4 rounded-lg font-bold text-[10px] uppercase italic transition-colors">Excel İndir</button>
                    <button onclick="resetSystem()" class="bg-red-900/40 text-red-400 border border-red-900/50 p-4 rounded-lg font-bold text-[10px] uppercase italic transition-colors">Sistemi Sıfırla</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { initializeFirestore, doc, onSnapshot, setDoc, collection, getDocs, deleteDoc, serverTimestamp, persistentLocalCache } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBsm4DNTCY681X1foMbx-79YfDqcMXTAcg",
            authDomain: "vigoanketler.firebaseapp.com",
            projectId: "vigoanketler",
            storageBucket: "vigoanketler.firebasestorage.app",
            messagingSenderId: "458653861576",
            appId: "1:458653861576:web:21176fee0e23f7d64007fd"
        };

        const app = initializeApp(firebaseConfig);
        
        // Connectivity Force: Long Polling enabled for enterprise WiFi and Operator proxy bypass
        const db = initializeFirestore(app, {
            experimentalForceLongPolling: true,
            localCache: persistentLocalCache()
        });

        const DAYS = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];
        let state = { config: { open: "", v: 1, quotas: {} }, votes: [], activeDay: null };

        // Data Syncing
        function initSync() {
            // Config Listener
            onSnapshot(doc(db, "v98_core", "config"), (s) => {
                if(s.exists()) {
                    state.config = s.data();
                    if(!state.config.quotas) state.config.quotas = {};
                    DAYS.forEach(d => { if(!state.config.quotas[d]) state.config.quotas[d] = 10; });
                    
                    // Update Admin UI
                    if(state.config.open) {
                        document.getElementById('admin-tarih').value = state.config.open;
                    }

                    document.getElementById('status').innerText = "SİSTEM AKTİF • BAĞLI";
                    document.getElementById('status').className = "text-[10px] font-bold tracking-widest status-online uppercase";
                    checkLock();
                    renderQuotas();
                }
                render();
            });

            // Votes Listener
            onSnapshot(collection(db, "v98_votes"), (s) => {
                state.votes = s.docs.map(d => d.data());
                render();
            });
        }

        function render() {
            const grid = document.getElementById('gunler-grid');
            grid.innerHTML = DAYS.map(d => {
                const count = state.votes.filter(v => v.day === d).length;
                const limit = state.config.quotas[d] || 10;
                const isFull = count >= limit;
                const isActive = state.activeDay === d;

                return `
                    <button onclick="window.selectDay('${d}', ${isFull})" 
                        class="p-4 vigo-card flex justify-between items-center transition-all ${isActive ? 'border-emerald-500 bg-emerald-500/10' : ''} ${isFull ? 'opacity-30 grayscale cursor-not-allowed' : ''}">
                        <span class="font-black text-sm uppercase tracking-wider ${isActive ? 'text-emerald-500' : ''}">${d}</span>
                        <span class="text-xs font-bold ${isFull ? 'text-red-500' : 'text-emerald-400'}">${count} / ${limit}</span>
                    </button>
                `;
            }).join('');

            const list = document.getElementById('liste-container');
            const groupedVotes = DAYS.map(d => {
                const users = state.votes.filter(v => v.day === d);
                if(users.length === 0) return '';
                return `
                    <div class="vigo-card p-4">
                        <div class="text-[9px] font-bold opacity-30 uppercase mb-2 italic">${d}</div>
                        <div class="flex flex-wrap gap-2">
                            ${users.map(u => `<span class="bg-slate-900 border border-slate-700 px-2 py-1 rounded text-[10px] font-bold uppercase">${u.name}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            list.innerHTML = groupedVotes || '<div class="text-center opacity-30 py-4 text-xs font-bold">Henüz kayıt yok.</div>';
        }

        function renderQuotas() {
            const box = document.getElementById('quota-list');
            box.innerHTML = DAYS.map(d => `
                <div class="flex items-center justify-between bg-slate-900 p-3 rounded-lg border border-slate-800">
                    <span class="text-[11px] font-black uppercase text-slate-400">${d}</span>
                    <div class="flex items-center gap-2">
                         <span class="text-[9px] opacity-30 font-bold">LİMİT:</span>
                         <input type="number" data-day="${d}" value="${state.config.quotas[d] || 10}" 
                         class="w-16 bg-slate-800 text-center rounded p-2 text-emerald-400 font-black border border-slate-700 focus:border-emerald-500 outline-none">
                    </div>
                </div>
            `).join('');
        }

        window.selectDay = (d, full) => {
            if(full) return;
            state.activeDay = d;
            const btn = document.getElementById('kaydet-btn');
            btn.disabled = false;
            btn.innerText = d.toUpperCase() + " GÜNÜNÜ KAYDET";
            render();
        }

        document.getElementById('kaydet-btn').onclick = async () => {
            const name = document.getElementById('kurye-ad').value.trim().toUpperCase();
            if(name.length < 3) return alert("Lütfen adınızı ve soyadınızı giriniz!");

            const btn = document.getElementById('kaydet-btn');
            btn.disabled = true;
            btn.innerText = "KAYDEDİLİYOR...";

            try {
                // Final Check
                const currentCount = state.votes.filter(v => v.day === state.activeDay).length;
                if(currentCount >= (state.config.quotas[state.activeDay] || 10)) {
                    alert("Üzgünüz, bu günün kontenjanı sizden önce doldu.");
                    return location.reload();
                }

                await setDoc(doc(db, "v98_votes", name), {
                    name, day: state.activeDay, v: state.config.v, ts: serverTimestamp()
                });
                
                localStorage.setItem('vigo_v98_lock', JSON.stringify({ name, day: state.activeDay, v: state.config.v }));
                location.reload();
            } catch(e) {
                console.error(e);
                alert("Bağlantı hatası oluştu. Lütfen tekrar deneyiniz.");
                btn.disabled = false;
            }
        };

        function checkLock() {
            const lock = localStorage.getItem('vigo_v98_lock');
            if(lock) {
                const data = JSON.parse(lock);
                if(data.v === state.config.v) {
                    document.getElementById('form-box').classList.add('hidden');
                    document.getElementById('success-box').classList.remove('hidden');
                    document.getElementById('secilen-bilgi').innerText = "GÜN: " + data.day;
                }
            }
        }

        window.resetLocal = () => {
            if(confirm("Seçiminizi değiştirmek istediğinize emin misiniz?")) {
                localStorage.removeItem('vigo_v98_lock');
                location.reload();
            }
        };

        window.openAdmin = () => { 
            const pw = prompt("Yönetici Şifresi:");
            if(pw === "vigo44") {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.body.style.overflow = "hidden";
            } else if(pw !== null) {
                alert("Hatalı şifre!");
            }
        };
        
        window.closeAdmin = () => {
            document.getElementById('admin-panel').classList.add('hidden');
            document.body.style.overflow = "auto";
        };

        window.saveConfig = async () => {
            const openVal = document.getElementById('admin-tarih').value;
            if(!openVal) return alert("Lütfen bir tarih ve saat seçiniz!");
            
            try {
                await setDoc(doc(db, "v98_core", "config"), { 
                    open: openVal 
                }, { merge: true });
                alert("Açılış zamanı başarıyla güncellendi.");
            } catch(e) {
                alert("Kaydedilemedi: " + e.message);
            }
        };

        window.saveQuotas = async () => {
            const inputs = document.querySelectorAll('#quota-list input');
            const newQuotas = {};
            inputs.forEach(i => newQuotas[i.dataset.day] = parseInt(i.value) || 0);
            
            try {
                await setDoc(doc(db, "v98_core", "config"), { quotas: newQuotas }, { merge: true });
                alert("Tüm kontenjanlar güncellendi.");
            } catch(e) {
                alert("Hata oluştu.");
            }
        };

        window.resetSystem = async () => {
            if(!confirm("Tüm kayıtlar silinecek ve sistem yeni sürüme (v) geçecek. Onaylıyor musunuz?")) return;
            
            try {
                const snap = await getDocs(collection(db, "v98_votes"));
                for(const d of snap.docs) await deleteDoc(doc(db, "v98_votes", d.id));
                
                const nextVersion = (state.config.v || 0) + 1;
                await setDoc(doc(db, "v98_core", "config"), { 
                    v: nextVersion 
                }, { merge: true });
                
                localStorage.removeItem('vigo_v98_lock');
                alert("Sistem tamamen sıfırlandı ve yeni dönem başlatıldı.");
                location.reload();
            } catch(e) {
                alert("Sıfırlama sırasında hata oluştu.");
            }
        };

        window.downloadExcel = () => {
            const sorted = state.votes.sort((a,b) => DAYS.indexOf(a.day) - DAYS.indexOf(b.day));
            const data = sorted.map(v => ({ "Kurye Ad Soyad": v.name, "Tercih Edilen Gün": v.day }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Vigo Katılım Listesi");
            XLSX.writeFile(wb, "Vigo_Force_V98_Rapor.xlsx");
        };

        function tick() {
            if(!state.config.open) {
                document.getElementById('countdown').innerText = "BEKLENİYOR";
                return requestAnimationFrame(tick);
            }

            const target = new Date(state.config.open).getTime();
            const now = Date.now();
            const diff = target - now;

            if(diff > 0) {
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('countdown').innerText = `${h}:${m}:${s}`;
                document.getElementById('form-box').classList.add('opacity-30', 'pointer-events-none');
            } else {
                document.getElementById('countdown').innerHTML = `<span class="text-emerald-400">AKTİF</span>`;
                document.getElementById('form-box').classList.remove('opacity-30', 'pointer-events-none');
            }
            requestAnimationFrame(tick);
        }

        initSync();
        tick();
    </script>
</body>
</html>
